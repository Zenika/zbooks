<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.zenika.zbooks.persistence.ZBooksMapper">
 
    <!-- Mapping ZBooks -->
    <resultMap type="ZBook" id="ZBook">
        <id column="ISBN" property="ISBN"  />
        <result column="title" property="title"  />
        <result column="edition" property="edition" />
        <result column="pagesNumber" property="pagesNumber" />
        <result column="releaseDate" property="releaseDate" />
        <result column="language" property="language" />
        <result column="collection" property="collection" />
        <collection property="author" column="ISBN" select="selectAllAuthorsByBook" javaType="ArrayList" />
    </resultMap>
    
    <resultMap type="Author" id="Author">
    	<id column="id" property="id" />
    	<result column="firstName" property="firstName" />
    	<result column="lastName" property="lastName" />
    </resultMap>
 
    <!-- ************************************************************************************* -->
 
    <!-- ZBooksMapper.selectAllAuthors() -->
    <select id="selectAllAuthorsByBook" resultMap="Author" parameterType="int" timeout="10" >
        SELECT * FROM linkAuthorZBooks WHERE isbn = #{isbn}
    </select>
    
    <select id="selectAllAuthors" resultMap="Author" timeout="10" >
        SELECT * FROM authors
    </select>
    
    <select id="getBook" resultMap="ZBook" parameterType="int" timeout="10">
    	SELECT * FROM zBooks WHERE isbn = #{isbn}
    </select>
    
    <select id="getAllBooks" resultMap="ZBook" timeout="10">
    	SELECT * FROM zBooks
    </select>
    
    <select id="getAuthorById" resultMap="Author" parameterType="int" timeout="10">
    	SELECT * FROM authors WHERE id = #{id}
    </select>

	<select id="getAuthorByName" resultMap="Author" parameterType="map" timeout="10">
		SELECT * FROM authors WHERE (firstName = #{firstName} AND lastName = #{lastName})
	</select>
	
	<insert id="addBook" parameterType="ZBook" timeout="10">
		INSERT INTO 
			zBooks (ISBN, title, edition, pagesNumber, releaseDate, language, collection) 
			VALUES
			(#{ISBN}, #{title}, #{edition}, #{pagesNumber}, #{releaseDate}, #{language}, #{collection});
		INSERT INTO 
			linkAuthorZBooks (ISBN, authorId)
			VALUES
			<foreach collection="authors" item="author">
				(#{ISBN}, #{author.id})
			</foreach>
	</insert>
	
	<delete id="deleteBook" parameterType="int" timeout="10">
		DELETE * FROM zBooks WHERE ISBN = #{ISBN}
		DELETE * FROM linkAuthorZBooks WHERE ISBN = #{ISBN}
	</delete>
	
	<insert id="addAuthor" parameterType="Author" timeout="10">
		INSERT INTO 
			authors (firstName, lastName)
			VALUES
			(#{firstName}, #{lastName})
	</insert>

</mapper>